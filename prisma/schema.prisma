// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum RiskProfile {
  AGGRESSIVE
  SEMI
  CONSERVATIVE
}

enum ReferralStatus {
  PENDING
  SIGNED_UP
  TRIAL
  QUALIFIED
  PAYABLE
  PAID
  VOID
}

enum CommissionType {
  FIXED
  PERCENT
}

enum AffiliatePayoutBatchStatus {
  DRAFT
  READY
  PAID
  CANCELLED
}

enum EmailOutboxStatus {
  QUEUED
  SENDING
  SENT
  FAILED
}

enum EmailType {
  WELCOME
  WELCOME_TRIAL
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                  String    @id @default(cuid())
  name                String?
  email               String    @unique
  emailVerified       DateTime?
  image               String?
  role                String    @default("guest")
  passwordHash        String?
  lastLoginAt         DateTime?
  loginCount          Int       @default(0)
  isActive            Boolean   @default(true)
  lockedUntil         DateTime? // Account lockout expiration
  failedLoginAttempts Int       @default(0) // Track failed attempts for lockout
  profileCompleted    Boolean   @default(false)
  onboardingCompleted Boolean   @default(false)
  timezone            String?
  preferences         String?
  clientId            String? // Multi-tenant support
  referralSlug        String?  @unique // Custom referral slug (e.g., "example")
  defaultRiskProfile  RiskProfile?
  selectedRiskProfile RiskProfile?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  accounts               Account[]
  sessions               Session[]
  memberships            Membership[]
  messages               Message[]
  channelReads           ChannelRead[]
  audits                 Audit[]
  media                  Media[]
  revisions              Revision[]
  bookmarks              Bookmark[]
  interests              UserInterest[]
  viewEvents             ViewEvent[]
  portfolioDailySignals  PortfolioDailySignal[]  @relation("PortfolioDailySignals")
  notifications          Notification[]
  notificationPreference NotificationPreference?
  hostedEvents           Event[]
  rsvps                  RSVP[]
  questions              Question[]
  votes                  Vote[]
  signalTrades           SignalTrade[]
  enrollments            Enrollment[]
  lessonProgress         LessonProgress[]
  quizSubmissions        QuizSubmission[]
  certificates           Certificate[]
  learningSessions       LearningSession[]
  cohortEnrollments      CohortEnrollment[]
  videos                 Video[]
  videoViews             VideoView[]
  securityEvents         SecurityEvent[]
  userSessions           UserSession[]
  client                 Client?                 @relation(fields: [clientId], references: [id], onDelete: SetNull)
  payments               Payment[]
  referralsAsReferrer    Referral[]              @relation("Referrer")
  referralsAsReferred    Referral?               @relation("Referred")
  referralsPaid          Referral[]              @relation("AffiliateReferralPaidBy")
  affiliatePayoutBatches AffiliatePayoutBatch[]  @relation("AffiliatePayoutReferrer")
  affiliatePayoutsPaid   AffiliatePayoutBatch[]  @relation("AffiliatePayoutPaidBy")
  commissions            Commission[]
  emailOutbox            EmailOutbox[]
  emailLogs              EmailLog[]
  dashboardSettingsUpdated DashboardSetting[]
  allocationSnapshotsUpdated AllocationSnapshot[]
  changeLogEventsCreated ChangeLogEvent[]
  roiDashboardSnapshotsUpdated RoiDashboardSnapshot[]
  riskOnboardingConfigsUpdated RiskOnboardingConfig[]
  onboardingResponses      UserOnboardingResponse[]
  riskProfileSnapshot      UserRiskProfile?

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@index([lastLoginAt])
  @@index([clientId])
  @@index([referralSlug])
}

model Client {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  domain      String? // Custom domain for client
  settings    String? // JSON string for client-specific settings
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@index([slug])
  @@index([isActive])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model SecurityEvent {
  id        String   @id @default(cuid())
  userId    String
  eventType String
  ipAddress String?
  userAgent String?
  success   Boolean
  metadata  String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  deviceInfo   String?
  ipAddress    String?
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String
  ipAddress String?
  success   Boolean
  reason    String?
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@index([createdAt])
}

model Membership {
  id                   String    @id @default(cuid())
  userId               String
  tier                 String
  status               String    @default("trial")
  stripeCustomerId     String? // Stripe Customer ID
  stripeSubscriptionId String? // Stripe Subscription ID
  stripePriceId        String? // Stripe Price ID
  currentPeriodStart   DateTime? // Current billing period start
  currentPeriodEnd     DateTime? // Current billing period end
  cancelAtPeriodEnd    Boolean   @default(false) // Cancel at period end
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@unique([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model Payment {
  id              String   @id @default(cuid())
  userId          String
  membershipId    String?
  stripePaymentId String   @unique // Stripe Payment Intent ID
  stripeInvoiceId String? // Stripe Invoice ID
  amount          Decimal
  currency        String   @default("usd")
  status          String // succeeded, pending, failed, refunded
  paymentMethod   String? // card, bank_transfer, etc.
  description     String?
  metadata        String? // JSON string for additional metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  membership  Membership?  @relation(fields: [membershipId], references: [id], onDelete: SetNull)
  commissions Commission[]

  @@index([userId])
  @@index([membershipId])
  @@index([stripePaymentId])
  @@index([status])
  @@index([createdAt])
}

model StripeWebhookEvent {
  id            String    @id @default(cuid())
  stripeEventId String    @unique // Stripe Event ID
  eventType     String // payment_intent.succeeded, customer.subscription.updated, etc.
  processed     Boolean   @default(false)
  processedAt   DateTime?
  payload       String // JSON string of full event payload
  error         String?
  createdAt     DateTime  @default(now())

  @@index([stripeEventId])
  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
}

model Content {
  id          String    @id @default(cuid())
  slug        String    @unique
  kind        String
  title       String
  excerpt     String?
  body        String?
  coverUrl    String?
  publishedAt DateTime  @default(now())
  publishAt   DateTime?
  locked      Boolean   @default(false)
  minTier     String?
  tags        String // JSON string array
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  revisions Revision[]
  bookmarks Bookmark[]
  videos    Video[]

  @@index([kind])
  @@index([publishedAt])
  @@index([locked])
  @@index([minTier])
  @@index([kind, publishedAt(sort: Desc)])
  @@index([kind, locked])
}

model Episode {
  id          String    @id @default(cuid())
  slug        String    @unique
  title       String
  excerpt     String?
  videoUrl    String?
  body        String?
  coverUrl    String?
  duration    Int?      // Duration in seconds
  category    String    @default("daily-update") // daily-update | analysis | breakdown
  publishedAt DateTime  @default(now())
  publishAt   DateTime?
  locked      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  bookmarks Bookmark[]

  @@index([category])
  @@index([publishedAt])
}

model Channel {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  messages Message[]
  reads    ChannelRead[]

  @@index([order])
}

model Message {
  id        String   @id @default(cuid())
  channelId String
  userId    String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([createdAt(sort: Desc)])
  @@index([channelId, createdAt(sort: Desc)])
}

model ChannelRead {
  id         String   @id @default(cuid())
  userId     String
  channelId  String
  lastReadAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
  @@index([userId])
  @@index([channelId])
  @@index([userId, channelId])
}

model Audit {
  id          String   @id @default(cuid())
  actorId     String
  action      String
  subjectType String
  subjectId   String?
  metadata    String? // JSON string for additional data
  createdAt   DateTime @default(now())

  actor User @relation(fields: [actorId], references: [id], onDelete: Cascade)
}

model Media {
  id           String   @id @default(cuid())
  url          String
  filename     String
  mime         String
  size         Int
  alt          String?
  title        String?
  uploadedById String
  createdAt    DateTime @default(now())

  uploader User @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
}

model Revision {
  id        String   @id @default(cuid())
  contentId String
  editorId  String
  title     String
  excerpt   String?
  body      String?
  coverUrl  String?
  createdAt DateTime @default(now())

  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)
  editor  User    @relation(fields: [editorId], references: [id], onDelete: Cascade)
}

// Note: SQLite doesn't support enums, using String fields with validation in application code
// Valid values:
// UserRole: "guest", "member", "editor", "admin"
// MembershipTier: "T1", "T2", "T3"  
// MembershipStatus: "active", "trial", "paused"
// ContentKind: "research", "macro", "signal", "resource"

// Member Experience v1 Models

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  // Only one of these will be set:
  contentId String? // Research/Resource/Signal content
  episodeId String? // Crypto Compass episode
  note      String?
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content Content? @relation(fields: [contentId], references: [id], onDelete: Cascade)
  episode Episode? @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@index([userId, contentId])
  @@index([userId, episodeId])
}

model UserInterest {
  id        String   @id @default(cuid())
  userId    String
  tag       String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tag])
  @@index([tag])
}

model ViewEvent {
  id         String   @id @default(cuid())
  userId     String
  entityType String // 'content' | 'episode'
  entityId   String
  createdAt  DateTime @default(now())
  // optional dwell time if we ever send it:
  durationMs Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, entityType, entityId])
  @@index([userId, entityType, entityId, createdAt])
}

model NotificationPreference {
  userId        String  @id
  // channels
  inApp         Boolean @default(true)
  email         Boolean @default(true) // Email enabled by default for portfolio updates
  // events
  onResearch    Boolean @default(true)
  onEpisode     Boolean @default(true)
  onSignal      Boolean @default(true) // Enabled by default for daily portfolio updates
  onMention     Boolean @default(true)
  onReply       Boolean @default(true)
  // digest
  digestEnabled Boolean @default(false)
  digestFreq    String  @default("weekly") // 'daily' | 'weekly'
  digestHourUTC Int     @default(9)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id         String    @id @default(cuid())
  userId     String
  type       String // 'research_published' | 'episode_published' | 'signal_published' | 'mention' | 'reply' | 'announcement'
  entityType String? // 'content' | 'episode' | 'message'
  entityId   String?
  title      String
  body       String?
  url        String?
  channel    String // 'inapp' | 'email' | 'push'
  readAt     DateTime?
  sentAt     DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, readAt])
  @@index([type])
  @@index([userId, type])
}

// Live Sessions & Events v1 Models

model Event {
  id           String   @id @default(cuid())
  slug         String   @unique
  title        String
  summary      String?
  description  String? // MDX allowed
  startAt      DateTime
  endAt        DateTime
  timezone     String // IANA, e.g., "Australia/Sydney"
  visibility   String   @default("member") // 'public' | 'member' | 'admin'
  locationType String   @default("online") // 'online' | 'in_person'
  locationText String? // address or "Zoom"
  joinUrl      String? // meeting link (shown near start time)
  capacity     Int?
  hostUserId   String?
  recordingUrl String? // after event
  resources    String? // JSON string for [{title,url}] after event
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  host       User?       @relation(fields: [hostUserId], references: [id], onDelete: SetNull)
  rsvps      RSVP[]
  questions  Question[]
  chapters   Chapter[]
  transcript Transcript?

  @@index([startAt])
  @@index([visibility, startAt])
}

model RSVP {
  id          String    @id @default(cuid())
  userId      String
  eventId     String
  status      String    @default("going") // 'going' | 'interested' | 'declined'
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  checkedInAt DateTime?

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([eventId, status])
}

model Question {
  id         String    @id @default(cuid())
  eventId    String
  userId     String
  body       String
  createdAt  DateTime  @default(now())
  answeredAt DateTime?
  answer     String?
  answeredBy String?
  archivedAt DateTime?

  event Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes Vote[]

  @@index([eventId, createdAt])
}

model Vote {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
}

model Transcript {
  id         String   @id @default(cuid())
  eventId    String   @unique
  source     String   @default("manual") // 'manual' | 'vtt' | 'srt'
  createdAt  DateTime @default(now())
  uploadedBy String?

  event    Event               @relation(fields: [eventId], references: [id])
  segments TranscriptSegment[]
}

model TranscriptSegment {
  id           String @id @default(cuid())
  transcriptId String
  startMs      Int
  endMs        Int?
  text         String

  transcript Transcript @relation(fields: [transcriptId], references: [id])

  @@index([transcriptId, startMs])
}

model Chapter {
  id        String   @id @default(cuid())
  eventId   String
  title     String
  startMs   Int
  createdAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id])

  @@index([eventId, startMs])
}

model SignalTrade {
  id        String  @id @default(cuid())
  slug      String  @unique
  symbol    String // e.g., BTC, ETH
  market    String  @default("crypto:spot") // 'crypto:spot' | 'crypto:perp' | ...
  direction String // 'long' | 'short'
  thesis    String? // MDX supported
  tags      String  @default("[]") // JSON string array

  entryTime  DateTime
  entryPrice Decimal
  stopLoss   Decimal?
  takeProfit Decimal?
  conviction Int? // 1-5
  riskPct    Decimal? // % of portfolio risked

  status    String    @default("open") // 'open' | 'closed'
  exitTime  DateTime?
  exitPrice Decimal?
  notes     String?

  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([status, symbol, entryTime])
  @@index([createdAt])
  @@index([tags])
}

model PortfolioSetting {
  id             String   @id @default(cuid())
  // Global backtest-like params to compute equity curve from trades
  baseCapitalUsd Decimal // e.g., 10000.00
  positionModel  String   @default("risk_pct") // 'risk_pct' | 'fixed_fraction'
  slippageBps    Int      @default(5) // 0.05%
  feeBps         Int      @default(10) // 0.10%
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model PortfolioDailySignal {
  id               String   @id @default(cuid())
  tier             String // 'T1' | 'T2' | 'T3'
  category         String? // 'majors' | 'memecoins' (only for T3)
  riskProfile      RiskProfile @default(CONSERVATIVE)
  signal           String // Main signal text (e.g., "100% Cash")
  executiveSummary String? // Executive summary text
  associatedData   String? // Associated data/conditions (JSON string)
  publishedAt      DateTime @default(now())
  createdById      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  createdBy User? @relation("PortfolioDailySignals", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([tier, publishedAt])
  @@index([tier, category, publishedAt])
  @@index([publishedAt])
}

model PerfSnapshot {
  id        String   @id @default(cuid())
  scope     String // 'ALL'|'YTD'|'1Y'|'90D' and/or a date range key
  hash      String // hash of trades + settings for cache key
  payload   String // JSON string of precomputed KPIs + series (equity, drawdown, heatmap bins)
  createdAt DateTime @default(now())

  @@index([scope, hash])
  @@index([createdAt])
}

model EmailOutbox {
  id             String           @id @default(cuid())
  userId         String?
  toEmail        String
  type           EmailType
  payload        Json
  status         EmailOutboxStatus @default(QUEUED)
  attempts       Int              @default(0)
  lastError      String?
  scheduledFor   DateTime         @default(now())
  sentAt         DateTime?
  idempotencyKey String           @unique
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status, scheduledFor])
  @@index([userId])
}

model EmailLog {
  id                String   @id @default(cuid())
  userId            String?
  toEmail           String
  type              EmailType
  providerMessageId String?
  sentAt            DateTime @default(now())
  createdAt         DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
}

model UserOnboardingResponse {
  id          String           @id @default(uuid())
  userId      String
  wizardKey   String           @default("RISK_ONBOARDING_V1")
  answers     Json
  status      OnboardingStatus @default(NOT_STARTED)
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, wizardKey])
  @@index([status])
  @@index([userId])
  @@map("user_onboarding_responses")
}

model UserRiskProfile {
  userId               String     @id
  recommendedProfile   RiskProfile
  score                Int
  drivers              Json
  version              Int        @default(1)
  completedAt          DateTime
  overriddenByAdmin    Boolean    @default(false)
  adminOverrideProfile RiskProfile?
  adminOverrideReason  String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([recommendedProfile])
  @@index([completedAt])
  @@map("user_risk_profile")
}

model RiskOnboardingConfig {
  id              String   @id @default("risk_onboarding_config")
  wizardKey       String   @default("RISK_ONBOARDING_V1")
  version         Int      @default(1)
  config          Json
  updatedByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  updatedByUser User? @relation(fields: [updatedByUserId], references: [id], onDelete: SetNull)

  @@index([updatedAt])
}

model DashboardSetting {
  id                String   @id @default("dashboard_settings")
  inceptionDate     DateTime
  disclaimerText    String   @default("")
  showBtcBenchmark  Boolean  @default(true)
  showEthBenchmark  Boolean  @default(true)
  showSimulator     Boolean  @default(true)
  showChangeLog     Boolean  @default(true)
  showAllocation    Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  updatedByUserId   String?

  updatedByUser User? @relation(fields: [updatedByUserId], references: [id], onDelete: SetNull)

  @@index([updatedAt])
}

model PerformanceSeries {
  id         String   @id @default(cuid())
  seriesType String
  portfolioKey String @default("dashboard")
  date       DateTime
  value      Decimal
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([seriesType, date, portfolioKey])
  @@index([seriesType, date])
  @@index([portfolioKey, date])
}

model AllocationSnapshot {
  id              String   @id @default(cuid())
  portfolioKey    String
  asOfDate        DateTime
  items           Json
  cashWeight      Decimal  @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  updatedByUserId String?

  updatedByUser User? @relation(fields: [updatedByUserId], references: [id], onDelete: SetNull)

  @@unique([portfolioKey, asOfDate])
  @@index([portfolioKey, asOfDate])
  @@index([updatedAt])
}

model AssetPriceDaily {
  id        String   @id @default(cuid())
  symbol    String
  date      DateTime
  close     Decimal
  source    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([symbol, date])
  @@index([symbol, date])
}

model ChangeLogEvent {
  id              String   @id @default(cuid())
  date            DateTime
  title           String
  summary         String
  linkUrl         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdByUserId String?

  createdByUser User? @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([date])
  @@index([createdAt])
}

model RoiDashboardSnapshot {
  id                String   @id @default(cuid())
  scope             String
  cacheKey          String
  payload           String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  portfolioKey      String?
  needsRecompute    Boolean  @default(false)
  recomputeFromDate DateTime?
  asOfDate          DateTime?
  roiInception      Decimal?
  roi30d            Decimal?
  maxDrawdown       Decimal?
  volatility        Decimal?
  lastComputedAt    DateTime?
  updatedByUserId   String?

  updatedByUser User? @relation(fields: [updatedByUserId], references: [id], onDelete: SetNull)

  @@index([scope, cacheKey])
  @@index([createdAt])
  @@index([portfolioKey])
  @@index([needsRecompute])
  @@unique([scope, portfolioKey])
}

model Track {
  id          String    @id @default(cuid())
  slug        String    @unique
  title       String
  summary     String?
  coverUrl    String?
  pdfResources Json?
  minTier     String    @default("member") // member | editor | admin
  publishedAt DateTime?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  sections     TrackSection[]
  lessons      Lesson[]
  enrollments  Enrollment[]
  certificates Certificate[]
  cohorts      Cohort[]

  @@index([publishedAt, order])
}

model TrackSection {
  id      String  @id @default(cuid())
  trackId String
  title   String
  summary String?
  order   Int     @default(0)

  track   Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([trackId, order])
}

model Lesson {
  id          String    @id @default(cuid())
  trackId     String
  sectionId   String?
  slug        String
  title       String
  contentMDX  String? // Optional - can be empty for video-only lessons
  durationMin Int? // estimated
  videoUrl    String?
  pdfResources Json?
  quizId      String?
  publishedAt DateTime?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  track            Track             @relation(fields: [trackId], references: [id], onDelete: Cascade)
  section          TrackSection?     @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  quiz             Quiz?
  progresses       LessonProgress[]
  quizSubmissions  QuizSubmission[]
  releases         LessonRelease[]
  videos           Video[]
  learningSessions LearningSession[]

  @@unique([trackId, slug])
  @@index([trackId, sectionId, order])
  @@index([publishedAt])
}

model Enrollment {
  id          String    @id @default(cuid())
  userId      String
  trackId     String
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  progressPct Int       @default(0)

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([userId, trackId])
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completedAt DateTime?
  timeSpentMs Int       @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([completedAt])
  @@index([userId, completedAt])
}

model Quiz {
  id        String @id @default(cuid())
  lessonId  String @unique
  passPct   Int    @default(70) // 70% to pass
  questions String // JSON string array of {id, kind:'mc', prompt, options:[...], correctIndexes:[...]}

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

model QuizSubmission {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  scorePct  Int
  passed    Boolean
  answers   String // JSON string array of {qId, selectedIndexes:[...]}
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId, lessonId, createdAt])
  @@index([passed])
  @@index([userId, passed])
}

model Certificate {
  id       String   @id @default(cuid())
  userId   String
  trackId  String
  code     String   @unique // shareable code
  issuedAt DateTime @default(now())
  meta     String? // JSON string

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([userId, trackId])
  @@index([code])
}

model LearningSession {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  startTime   DateTime
  endTime     DateTime?
  timeSpentMs Int       @default(0)
  sessionType String    @default("lesson") // lesson | quiz | review
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId, startTime])
  @@index([lessonId, startTime])
}

model Cohort {
  id          String    @id @default(cuid())
  trackId     String
  slug        String    @unique
  title       String
  description String?
  startsAt    DateTime
  endsAt      DateTime?
  timezone    String    @default("Australia/Sydney") // IANA timezone
  visibility  String    @default("member") // member | admin
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  track       Track              @relation(fields: [trackId], references: [id], onDelete: Cascade)
  enrollments CohortEnrollment[]
  releases    LessonRelease[]

  @@index([trackId, startsAt])
  @@index([visibility])
}

model CohortEnrollment {
  id       String   @id @default(cuid())
  cohortId String
  userId   String
  joinedAt DateTime @default(now())
  role     String   @default("member") // member | coach

  cohort Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cohortId, userId])
  @@index([cohortId])
  @@index([userId])
}

model LessonRelease {
  id        String   @id @default(cuid())
  cohortId  String
  lessonId  String
  releaseAt DateTime // when this lesson becomes visible for this cohort

  cohort Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([cohortId, lessonId])
  @@index([cohortId, releaseAt])
  @@index([releaseAt])
}

model Video {
  id          String   @id @default(cuid())
  title       String
  description String?
  filename    String // Original uploaded filename
  filePath    String // Path to video file on disk
  thumbnail   String? // Path to thumbnail image
  duration    Int? // Duration in seconds
  fileSize    Int? // File size in bytes
  mimeType    String   @default("video/mp4")
  resolution  String? // e.g., "1920x1080"
  status      String   @default("processing") // processing | ready | error
  visibility  String   @default("member") // member | admin | public
  uploadedBy  String // User ID who uploaded
  contentId   String? // Optional link to content piece
  lessonId    String? // Optional link to lesson
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  uploader User        @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)
  content  Content?    @relation(fields: [contentId], references: [id], onDelete: SetNull)
  lesson   Lesson?     @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  views    VideoView[]

  @@index([uploadedBy])
  @@index([status])
  @@index([visibility])
  @@index([createdAt])
}

model VideoView {
  id        String   @id @default(cuid())
  videoId   String
  userId    String?
  viewedAt  DateTime @default(now())
  duration  Int? // How long they watched (in seconds)
  completed Boolean  @default(false) // Did they watch the whole video?

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([userId])
  @@index([viewedAt])
  @@index([completed])
  @@index([videoId, completed])
}

model Referral {
  id             String    @id @default(cuid())
  referrerId     String // User who created the referral link
  referredUserId String?   @unique // User who signed up via the link (null until signup) - unique so user can only be referred once
  referralCode   String    // Reusable code - same code can be used by multiple people
  status         ReferralStatus @default(PENDING)
  referredEmail  String?
  referredName   String?
  slugUsed       String?
  source         String?
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  utmTerm        String?
  utmContent     String?
  clickedAt      DateTime?
  signedUpAt     DateTime?
  trialStartedAt DateTime?
  trialEndsAt    DateTime?
  firstPaidAt    DateTime?
  qualifiedAt    DateTime?
  commissionType CommissionType?
  commissionValue Decimal?
  commissionAmountCents Int?
  currency       String    @default("usd")
  holdDays       Int?
  payableAt      DateTime?
  paidAt         DateTime?
  paidByUserId   String?
  payoutBatchId  String?
  expiresAt      DateTime? // Optional expiration date
  createdAt      DateTime  @default(now())
  completedAt    DateTime? // When the referred user completed signup
  metadata       String? // JSON string for additional data (IP address, user agent, etc.)

  referrer      User         @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referredUser  User?        @relation("Referred", fields: [referredUserId], references: [id], onDelete: SetNull)
  paidByUser    User?        @relation("AffiliateReferralPaidBy", fields: [paidByUserId], references: [id], onDelete: SetNull)
  payoutBatch   AffiliatePayoutBatch? @relation(fields: [payoutBatchId], references: [id], onDelete: SetNull)
  commissions   Commission[]

  @@index([referrerId])
  @@index([referralCode])
  @@index([status])
  @@index([referrerId, status])
  @@index([payableAt])
  @@index([payoutBatchId])
  @@index([createdAt])
}

model AffiliatePayoutBatch {
  id              String     @id @default(cuid())
  referrerId      String
  status          AffiliatePayoutBatchStatus @default(DRAFT)
  totalAmountCents Int
  currency        String     @default("usd")
  dueAt           DateTime?
  paidAt          DateTime?
  paidByUserId    String?
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  referrer   User     @relation("AffiliatePayoutReferrer", fields: [referrerId], references: [id], onDelete: Cascade)
  paidByUser User?    @relation("AffiliatePayoutPaidBy", fields: [paidByUserId], references: [id], onDelete: SetNull)
  referrals  Referral[]

  @@index([referrerId])
  @@index([status])
  @@index([dueAt])
}

model Commission {
  id              String    @id @default(cuid())
  referralId      String
  paymentId       String // Link to the payment that generated commission
  referrerId      String // User who earns the commission
  amount          Decimal // Commission amount (15% of payment amount)
  currency        String    @default("usd")
  status          String    @default("pending") // pending | paid | cancelled | refunded
  paidAt          DateTime?
  payoutMethod    String? // How commission was paid (e.g., "stripe", "manual", "bank_transfer")
  payoutReference String? // Reference number for payout
  notes           String? // Admin notes
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  referral Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  payment  Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  referrer User     @relation(fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([status])
  @@index([paymentId])
  @@index([referralId])
  @@index([createdAt])
  @@index([referrerId, status])
}
